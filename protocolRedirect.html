<!DOCTYPE HTML>
<meta charset="utf-8" />
<title>Private Tab: Redirectâ€¦</title>
<div id="output"></div>
<div id="usage" style="display: none;">
	Usage example: <a href="private:https://addons.mozilla.org/">private:https://addons.mozilla.org/</a>
</div>
<script>
try {
	Components.utils.import("resource://gre/modules/Services.jsm");
	// Example: private:///#http://example.com/ (legacy) or private:http://example.com/
	// Note: we use protocolRedirect.html#http://..., but we never (?) have it here
	var spec = location.protocol == "private:"
		? location.href.replace(/^\w+:\/*#?/, "")
		: location.hash.substr(1);

	try {
		updateUI();
	}
	catch(e2) {
		Components.utils.reportError(e2);
	}

	if(!spec)
		throw new Error("No URI");
	if(!/^[^:]+:/.test(spec))
		spec = "http://" + spec;
	var testChannel = validateURI(spec);
	document.title = getLoadingTitle() || spec;
	location.replace(spec);
}
catch(e) {
	document.title = "Private Tab: Can't redirect";
	var out;
	if(!("Services" in window)) // We can open this file directly using jar:file:///...
		out = "Not enough permissions";
	else {
		setFavicon("chrome://global/skin/icons/warning-16.png");
		if(!spec)
			out = "Missing URI";
		else if(!testChannel)
			out = "Malformed URI: " + spec;
	}
	out && document.getElementById("output").appendChild(document.createTextNode(out));
	document.getElementById("usage").style.display = "";
	throw e;
}

function updateUI() {
	var dwu = "inIDOMUtils" in Components.interfaces
		? Components.classes["@mozilla.org/inspector/dom-utils;1"]
			.getService(Components.interfaces.inIDOMUtils)
		: InspectorUtils; // Firefox 59+
	var browser = dwu.getParentForNode(document, true);
	if(
		isXULElement(browser)
		&& browser.localName.toLowerCase() == "browser"
	) {
		var win = browser.ownerDocument.defaultView;
		if("privateTab" in win)
			win.privateTab._handleProtocolBrowser(browser, document.documentURIObject);
		return;
	}
	// Looks like multi-process mode
	var mm = "nsIContentFrameMessageManager" in Components.interfaces
		? window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
			.getInterface(Components.interfaces.nsIDocShell)
			.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
			.getInterface(Components.interfaces.nsIContentFrameMessageManager)
		: window.docShell.messageManager; // Firefox 63+
	mm.sendAsyncMessage("PrivateTab:ProtocolURILoaded", {
		URI: document.documentURI
	});
}
function isXULElement(node) {
	// https://bugzilla.mozilla.org/show_bug.cgi?format=default&id=1452185
	return "nsIDOMXULElement" in Components.interfaces
		? node instanceof Components.interfaces.nsIDOMXULElement
		: node && ChromeUtils.getClassName(node) == "XULElement"; // Firefox 61+
}
function validateURI(spec) { // Returns test nsIChannel or throws
	var uri = Services.io.newURI(spec, null, null);
	if(uri.scheme == "about" && "nsIAboutModule" in Components.interfaces) {
		var req = new XMLHttpRequest();
		req.open("head", "about:config", true); // Trick to get privileged nsILoadInfo
		var loadInfo = req.channel.loadInfo;
		return Components.classes[
			"@mozilla.org/network/protocol/about;1?what="
			+ (uri.path || uri.pathQueryRef || "").replace(/[?&#].*$/, "")
		]
			.getService(Components.interfaces.nsIAboutModule)
			.newChannel(uri, loadInfo /* nsILoadInfo since Firefox 36 */);
	}
	var pv = parseFloat(Services.appinfo.platformVersion);
	if(Services.appinfo.name == "Pale Moon" || Services.appinfo.name == "Basilisk")
		pv = pv >= 4.1 ? 56 : 28;
	return "newChannelFromURIWithLoadInfo" in Services.io // Firefox 37+
		&& pv >= 44 // Throws in Firefox 37-43 with null nsILoadInfo
		? Services.io.newChannelFromURIWithLoadInfo(uri, null)
		: Services.io.newChannelFromURI(uri); // Deprecated in Firefox 48+
}
function getLoadingTitle() {
	function string(file, id) {
		try {
			return Services.strings.createBundle(file).GetStringFromName(id);
		}
		catch(e) {
		}
		return "";
	}
	return string("chrome://browser/locale/tabbrowser.properties", "tabs.connecting") // Firefox
		|| string("chrome://navigator/locale/tabbrowser.properties", "tabs.loading"); // SeaMonkey
}
function setFavicon(iconURL) {
	var icon = document.createElement("link");
	icon.href = iconURL;
	icon.rel = "shortcut icon";
	document.documentElement.insertBefore(icon, document.documentElement.firstChild);
}
</script>